<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ç™»ç§‘ã€éœä¿®æ ¡ã€‘é›²ç«¯å¸³å‹™ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #ffecec; font-family: "Microsoft JhengHei", sans-serif; }
        .main-title { color: #0099cc; font-weight: bold; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
        .highlight-red { color: #dc3545; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; border-radius: 10px; margin-bottom: 20px; }
        .card-header { background-color: #0d6efd; color: white; font-weight: bold; }
        #amount { background-color: #ffdddd; border-color: #ffcccc; font-weight: bold; }
        .d-none { display: none !important; }
        
        #loading-overlay, #login-overlay, #logout-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        #loading-overlay { background: rgba(0,0,0,0.5); color: white; flex-direction: column; display: none;}
        #login-overlay { background: rgba(255,236,236, 0.98); }
        #logout-overlay { background: rgba(0,0,0,0.85); display: none; }
        .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border text-light mb-3" role="status"></div>
    <h4 id="loading-text">è³‡æ–™åŒæ­¥ä¸­...</h4>
</div>

<div id="logout-overlay">
    <div class="card p-4 text-center" style="width: 400px; border: 2px solid #dc3545;">
        <h3 class="text-danger mb-3"><i class="fas fa-exclamation-triangle"></i> ç™»å‡ºæé†’</h3>
        <p class="mb-4 text-muted">ç³»çµ±å°‡è‡ªå‹•å½™æ•´ä»Šæ—¥æ–°å¢è³‡æ–™ä¸¦ç™¼é€é€šçŸ¥ä¿¡ã€‚</p>
        <div class="d-grid gap-3">
            <button class="btn btn-success btn-lg" onclick="exportLastMonthData()">
                <i class="fas fa-file-excel"></i> 1. åŒ¯å‡ºè¿‘ä¸€å€‹æœˆ EXCEL
            </button>
            <button class="btn btn-outline-secondary btn-lg" onclick="finalLogout()">
                <i class="fas fa-sign-out-alt"></i> 2. å·²åŒ¯å‡ºï¼ŒçµæŸç¨‹å¼
            </button>
            <button class="btn btn-link text-muted" onclick="document.getElementById('logout-overlay').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="login-overlay">
    <div class="card p-4" style="width: 350px;">
        <div class="text-center mb-3">
            <h3 class="main-title">ç³»çµ±ç™»å…¥</h3>
            <small class="text-muted">é«˜ç™»ç§‘<span class="highlight-red">ã€éœä¿®æ ¡ã€‘</span>é›²ç«¯å¸³å‹™</small>
        </div>
        <form id="loginForm">
            <div class="mb-3"><label class="form-label">å¸³è™Ÿ</label><input type="text" class="form-control" id="loginUser" required placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"></div>
            <div class="mb-3"><label class="form-label">å¯†ç¢¼</label><input type="password" class="form-control" id="loginPass" required placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></div>
            <button type="submit" class="btn btn-primary w-100">ç™»å…¥ä¸¦é€£ç·šè³‡æ–™åº«</button>
            <div id="loginError" class="text-danger text-center mt-2 small"></div>
        </form>
    </div>
</div>

<div class="container py-4" id="main-app" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="main-title m-0"><i class="fas fa-cloud"></i> é«˜ç™»ç§‘<span class="highlight-red">ã€éœä¿®æ ¡ã€‘</span>é›²ç«¯å¸³å‹™</h2>
        <div>
            <span class="me-2 text-secondary"><i class="fas fa-user-circle"></i> <span id="displayUsername">User</span></span>
            <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('logout-overlay').style.display='flex'">ç™»å‡º</button>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#input"><i class="fas fa-pen"></i> æ”¶æ”¯ç™»éŒ„</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#report" onclick="updateDateRange()"><i class="fas fa-chart-pie"></i> å ±è¡¨åŒ¯æ•´</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#manage"><i class="fas fa-cogs"></i> è¨­å®š</button></li>
        <li class="nav-item d-none" id="adminTab"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#users"><i class="fas fa-users-cog"></i> ä½¿ç”¨è€…ç®¡ç†</button></li>
        <li class="nav-item d-none" id="logTab"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#logs"><i class="fas fa-history"></i> æ“ä½œç´€éŒ„</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="input">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header" id="formTitle">æ–°å¢äº¤æ˜“</div>
                        <div class="card-body">
                            <form id="accountForm">
                                <input type="hidden" id="editId">
                                <div class="mb-3"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-control" id="date" required></div>
                                <div class="mb-3"><label class="form-label">æ”¶æ”¯é¡å‹</label><select class="form-select" id="type" onchange="updateCategoriesFromSettings()" required><option value="expense" selected>æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select></div>
                                <div class="mb-3"><label class="form-label">é …ç›®åˆ†é¡</label><select class="form-select" id="category" required onchange="checkMealCategory()"></select></div>
                                <div class="mb-3"><label class="form-label">é‡‘é¡</label><input type="number" class="form-control" id="amount" placeholder="è¼¸å…¥é‡‘é¡" required></div>
                                <div class="mb-3">
                                    <label class="form-label">å…§å®¹ (å‚™è¨»)</label>
                                    <input type="text" class="form-control" id="descInput">
                                    <select class="form-select d-none" id="descSelect" onchange="checkMealOption()"></select>
                                    <input type="text" class="form-control mt-2 d-none" id="descOtherInput" placeholder="è«‹è¼¸å…¥æ–°åº—å®¶åç¨± (å°‡è‡ªå‹•å„²å­˜)">
                                </div>
                                <button type="submit" class="btn btn-primary w-100" id="submitBtn"><i class="fas fa-check"></i> è¨˜éŒ„ä¸¦é€å‡º</button>
                                <button type="button" class="btn btn-secondary w-100 mt-2 d-none" id="cancelEditBtn" onclick="cancelEdit()">å–æ¶ˆä¿®æ”¹</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-list"></i> é›²ç«¯è³‡æ–™åˆ—è¡¨ <button class="btn btn-sm btn-light ms-2" onclick="fetchCloudData()">ğŸ”„</button></span>
                            <span id="currentBalance" class="badge bg-warning text-dark">0</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-hover table-sm sticky-top">
                                    <thead class="table-light"><tr><th>æ—¥æœŸ</th><th>åˆ†é¡</th><th>å…§å®¹</th><th class="text-end">é‡‘é¡</th><th>æ“ä½œ</th></tr></thead>
                                    <tbody id="transactionList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="report">
            <div class="card border-info">
                <div class="card-header bg-info text-dark fw-bold">æœŸé–“å ±è¡¨çµ±è¨ˆ</div>
                <div class="card-body bg-white">
                    <div class="row g-3 align-items-end mb-4 border-bottom pb-3">
                        <div class="col-md-3"><label class="form-label">æœŸé–“</label><select class="form-select" id="reportPeriodMode" onchange="updateDateRange()"><option value="thisMonth" selected>æœ¬æœˆ</option><option value="lastMonth">ä¸Šæœˆ</option><option value="custom">è‡ªè¨‚</option></select></div>
                        <div class="col-md-3"><input type="date" class="form-control" id="reportStartDate" onchange="updatePreviewStats()"></div>
                        <div class="col-md-3"><input type="date" class="form-control" id="reportEndDate" onchange="updatePreviewStats()"></div>
                        <div class="col-md-3"><button class="btn btn-success w-100" onclick="exportComplexExcel()"><i class="fas fa-file-excel"></i> åŒ¯å‡º Excel</button></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><div class="card h-100 border-success"><div class="card-header bg-success text-white">æ”¶å…¥</div><div class="card-body p-0"><table class="table table-striped mb-0"><tbody id="preview-income-body"></tbody></table></div></div></div>
                        <div class="col-md-6"><div class="card h-100 border-danger"><div class="card-header bg-danger text-white">æ”¯å‡º</div><div class="card-body p-0"><table class="table table-striped mb-0"><tbody id="preview-expense-body"></tbody></table></div></div></div>
                    </div>
                    <div class="alert alert-secondary text-center fw-bold">æœ¬æœŸçµé¤˜: <span id="preview-final-balance" class="text-primary fs-5">0</span></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="manage">
            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-dark"><i class="fas fa-utensils"></i> é¤è²»æ”¯å‡ºé¸é …è¨­å®š (é›²ç«¯åŒæ­¥)</div>
                <div class="card-body">
                    <p class="text-muted small">æ­¤è™•æ–°å¢æˆ–ä¿®æ”¹çš„é¸é …æœƒåŒæ­¥è‡³é›²ç«¯ç³»çµ±ã€‚</p>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="newMealOpt" placeholder="è¼¸å…¥æ–°åº—å®¶åç¨±">
                        <button class="btn btn-outline-dark" onclick="addMealOption()">æ–°å¢é¸é …</button>
                    </div>
                    <div id="mealOptionList" class="d-flex flex-wrap gap-2 p-2 border rounded bg-white"></div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">æ”¶æ”¯é …ç›®åˆ†é¡</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 border-end"><h6>æ”¯å‡ºåˆ†é¡</h6><div class="input-group mb-2"><input type="text" class="form-control" id="newExpenseCat"><button class="btn btn-outline-danger" onclick="addCategory('expense')">æ–°å¢</button></div><div id="expenseCatList"></div></div>
                        <div class="col-md-6"><h6>æ”¶å…¥åˆ†é¡</h6><div class="input-group mb-2"><input type="text" class="form-control" id="newIncomeCat"><button class="btn btn-outline-success" onclick="addCategory('income')">æ–°å¢</button></div><div id="incomeCatList"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="users">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white"><i class="fas fa-users-cog"></i> é›²ç«¯ä½¿ç”¨è€…å¸³è™Ÿç®¡ç†</div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">æ–°å¢ä½¿ç”¨è€…</h6>
                                    <form id="newUserForm">
                                        <div class="mb-2"><input type="text" class="form-control" id="newUsername" placeholder="å¸³è™Ÿ" required></div>
                                        <div class="mb-2"><input type="text" class="form-control" id="newRealname" placeholder="é¡¯ç¤ºåç¨±" required></div>
                                        <div class="mb-2"><input type="password" class="form-control" id="newPassword" placeholder="å¯†ç¢¼" required></div>
                                        <div class="mb-2"><select class="form-select" id="newRole"><option value="user">ä¸€èˆ¬ä½¿ç”¨è€…</option><option value="admin">ç®¡ç†è€…</option></select></div>
                                        <button type="submit" class="btn btn-primary w-100">å»ºç«‹é›²ç«¯å¸³è™Ÿ</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8"><table class="table table-bordered"><thead><tr><th>å¸³è™Ÿ</th><th>åç¨±</th><th>æ¬Šé™</th><th>æ“ä½œ</th></tr></thead><tbody id="userListBody"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="logs">
            <div class="card border-secondary">
                <div class="card-header bg-secondary text-white"><i class="fas fa-history"></i> é›²ç«¯æ“ä½œç´€éŒ„</div>
                <div class="card-body">
                    <div class="table-responsive"><table class="table table-striped table-sm" style="font-size: 0.85rem;"><thead><tr><th style="width:160px;">æ™‚é–“</th><th>æ“ä½œäººå“¡</th><th>å‹•ä½œ</th><th>è©³æƒ…</th></tr></thead><tbody id="logListBody"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // â–¼â–¼â–¼ æ‚¨çš„ç¶²å€ â–¼â–¼â–¼
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzGnWo-GWlavpYjMb5I6IwCIAsMlSeu2eHou2chlJPJELckyTU7bsln1Ho7F68n2VA-Gw/exec';
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    let transactions = [];
    let cloudUsers = [];
    let cloudLogs = [];
    let currentUser = null;
    let sessionActions = []; // ğŸ”¥ å­˜æ”¾æœ¬æ¬¡ç™»å…¥çš„æ“ä½œï¼Œç™»å‡ºæ™‚æ‰å¯„ä¿¡
    
    // é è¨­è¨­å®š (è‹¥é›²ç«¯æ²’è³‡æ–™æ™‚ä½¿ç”¨)
    let settings = {
        expense: ["è£œç¿’ç­é›œæ”¯", "æ•™ææ–‡å…·é¡æ”¯å‡º", "å¹´åº¦æ•™æ(å¸³è™Ÿ/åˆç´„)", "é¤è²»æ”¯å‡º", "åŠ æ²¹", "æ°´é›»è²» é›»è©±è²»", "å…¶ä»–äººäº‹æ”¯å‡º", "è»Šè¼›ç›¸é—œæ”¯å‡º"],
        income: ["å…¥å¸³(é›¶ç”¨é‡‘)", "å­¸ç”Ÿè½‰å…¥é¤è²»", "å…¶ä»–æ”¶å…¥"],
        mealOptions: ["å¤©é£Ÿé‹ç‡’", "Bé´¨è‘£", "ä¾†ç¢—ç²¥", "é£¯å·", "æ°´é¤ƒå³°", "å¤ªç¥–é­·é­šç¾®", "å…«æ–¹é‹èƒ‹", "é˜¿èƒ–é£Ÿå ‚", "é»å¿ƒ"]
    };

    function getTodayString() { const n=new Date(); return new Date(n.getTime()-(n.getTimezoneOffset()*60000)).toISOString().slice(0,10); }

    // 1. ç™»å…¥
    document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        showLoading('æ­£åœ¨é©—è­‰å¸³è™Ÿ...');
        fetch(scriptURL)
        .then(res => res.json())
        .then(res => {
            if(res.result === 'success') {
                const users = res.data.users;
                // è‹¥é›²ç«¯æœ‰è¨­å®šï¼Œå‰‡è¦†è“‹æœ¬åœ°è¨­å®š (åŒæ­¥æ©Ÿåˆ¶)
                if(res.data.settings) settings = res.data.settings;
                
                let foundUser = users.find(x => String(x.username) === u && String(x.password) === p);
                if(!foundUser && u === 'admin' && p === '54381017') foundUser = { username: 'admin', role: 'admin', name: 'ç³»çµ±é è¨­ç®¡ç†å“¡' };

                if(foundUser) {
                    currentUser = foundUser;
                    sessionActions = []; // æ¸…ç©ºæ“ä½œç´€éŒ„
                    loginSuccess();
                } else { document.getElementById('loginError').innerText = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'; }
            } else { alert('é€£ç·šå¤±æ•—'); }
        })
        .catch(err => { console.error(err); alert('ç¶²è·¯éŒ¯èª¤'); })
        .finally(() => hideLoading());
    });

    function loginSuccess() {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('displayUsername').innerText = `${currentUser.name} (${currentUser.role==='admin'?'ç®¡ç†å“¡':'ä½¿ç”¨è€…'})`;
        document.getElementById('date').value = getTodayString();
        if(currentUser.role === 'admin') {
            document.getElementById('adminTab').classList.remove('d-none');
            document.getElementById('logTab').classList.remove('d-none');
        }
        renderSettings();
        updateCategoriesFromSettings();
        fetchCloudData();
        logToCloud('ç™»å…¥', 'ä½¿ç”¨è€…ç™»å…¥ç³»çµ±');
    }

    // 2. ç™»å‡ºèˆ‡å¯„ä¿¡
    function finalLogout() {
        showLoading('æ­£åœ¨åŒ¯ç¸½è³‡æ–™ä¸¦ç™¼é€é€šçŸ¥...');
        
        // å‚³é€ sessionActions çµ¦å¾Œç«¯ç™¼ä¿¡
        fetch(scriptURL, {
            method: 'POST',
            body: JSON.stringify({
                op: 'send_summary',
                user: currentUser.name,
                time: new Date().toLocaleString(),
                summary: sessionActions
            }),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(res => res.json())
        .finally(() => {
            location.reload(); // ç„¡è«–å¯„ä¿¡æˆåŠŸèˆ‡å¦ï¼Œæœ€å¾Œéƒ½é‡æ•´ç™»å‡º
        });
    }

    // 3. é›²ç«¯é€šè¨Š
    function showLoading(text) { document.getElementById('loading-text').innerText = text; document.getElementById('loading-overlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }
    function fetchCloudData() {
        showLoading('åŒæ­¥é›²ç«¯è³‡æ–™ä¸­...');
        fetch(scriptURL).then(res => res.json()).then(res => {
            if(res.result === 'success') {
                transactions = res.data.transactions;
                cloudUsers = res.data.users;
                cloudLogs = res.data.logs;
                // åŒæ­¥è¨­å®š
                if(res.data.settings) {
                    settings = res.data.settings;
                    renderSettings();
                    updateCategoriesFromSettings();
                }
                renderTable(); updatePreviewStats();
                if(currentUser && currentUser.role === 'admin') { renderUserList(); renderLogs(); }
            }
        }).catch(err => alert('é€£ç·šéŒ¯èª¤')).finally(() => hideLoading());
    }
    
    function sendCloudCommand(payload, successMsg, callback) {
        showLoading('è³‡æ–™åŒæ­¥ä¸­...');
        fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload), headers: { "Content-Type": "text/plain;charset=utf-8" } })
        .then(res => res.json()).then(res => {
            if(res.result === 'success') {
                if(successMsg) alert(successMsg); fetchCloudData(); if(callback) callback();
            } else { alert('æ“ä½œå¤±æ•—: ' + res.message); }
        }).finally(() => hideLoading());
    }
    
    // å„²å­˜è¨­å®šåˆ°é›²ç«¯
    function saveSettingsToCloud() {
        // ä¸é¡¯ç¤º Loadingï¼ŒèƒŒæ™¯å„²å­˜
        fetch(scriptURL, {
            method: 'POST',
            body: JSON.stringify({ op: 'save_settings', settings: settings }),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        });
    }

    function logToCloud(action, detail) {
        if(!currentUser) return;
        fetch(scriptURL, { method: 'POST', body: JSON.stringify({ op: 'add', tableName: 'logs', user: currentUser.username, action: action, detail: detail }), headers: { "Content-Type": "text/plain;charset=utf-8" } });
    }

    // 4. å¸³å‹™èˆ‡è‡ªå‹•å­¸ç¿’
    document.getElementById('accountForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const cat = document.getElementById('category').value;
        let finalDesc;
        let isNewMeal = false;
        
        if (cat === 'é¤è²»æ”¯å‡º') {
            const selectVal = document.getElementById('descSelect').value;
            if (selectVal === 'other') {
                finalDesc = document.getElementById('descOtherInput').value.trim();
                if (finalDesc && !settings.mealOptions.includes(finalDesc)) {
                    settings.mealOptions.push(finalDesc);
                    isNewMeal = true;
                }
            } else { finalDesc = selectVal; }
        } else { finalDesc = document.getElementById('descInput').value.trim(); }

        const editId = document.getElementById('editId').value;
        const payload = {
            op: editId ? 'edit' : 'add', tableName: 'transactions', id: editId ? editId : Date.now(),
            date: document.getElementById('date').value, type: document.getElementById('type').value, category: cat,
            amount: document.getElementById('amount').value, desc: finalDesc, createdBy: currentUser.username
        };
        
        sendCloudCommand(payload, editId ? 'ä¿®æ”¹æˆåŠŸ' : 'è¨˜éŒ„ä¸¦é€å‡ºæˆåŠŸ', () => {
            cancelEdit();
            if(isNewMeal) { saveSettingsToCloud(); renderSettings(); } // æ–°å¢åº—å®¶å¾ŒåŒæ­¥é›²ç«¯
        });

        // åŠ å…¥æš«å­˜ï¼Œæº–å‚™ç™»å‡ºæ™‚å¯„ä¿¡
        if(!editId) {
            sessionActions.push({ action: 'æ–°å¢', category: cat, amount: payload.amount, desc: finalDesc });
            logToCloud('æ–°å¢äº¤æ˜“', `${cat} $${payload.amount}`);
        } else {
            sessionActions.push({ action: 'ä¿®æ”¹', category: cat, amount: payload.amount, desc: finalDesc });
            logToCloud('ä¿®æ”¹äº¤æ˜“', `ID: ${editId}`);
        }
    });

    function deleteTrans(id) { 
        if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { 
            sendCloudCommand({ op: 'delete', tableName: 'transactions', id: id }, 'åˆªé™¤æˆåŠŸ'); 
            sessionActions.push({ action: 'åˆªé™¤', category: '-', amount: '-', desc: `ID:${id}` });
            logToCloud('åˆªé™¤äº¤æ˜“', `ID: ${id}`); 
        } 
    }

    // 5. è¨­å®šç®¡ç† (CRUD ä¸¦åŒæ­¥é›²ç«¯)
    function addCategory(t){ const v=document.getElementById(t==='expense'?'newExpenseCat':'newIncomeCat').value.trim(); if(v){settings[t].push(v); saveSettingsToCloud(); renderSettings(); updateCategoriesFromSettings();}}
    function removeCat(t,i){if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){settings[t].splice(i,1); saveSettingsToCloud(); renderSettings(); updateCategoriesFromSettings();}}
    
    function addMealOption() { const v = document.getElementById('newMealOpt').value.trim(); if(v && !settings.mealOptions.includes(v)) { settings.mealOptions.push(v); saveSettingsToCloud(); renderSettings(); document.getElementById('newMealOpt').value = ''; } }
    function removeMealOpt(i) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { settings.mealOptions.splice(i, 1); saveSettingsToCloud(); renderSettings(); } }
    function editMealOpt(i) { 
        const old = settings.mealOptions[i]; const n = prompt("ä¿®æ”¹åç¨±:", old); 
        if(n && n.trim()!==old){ 
            settings.mealOptions[i]=n.trim(); 
            saveSettingsToCloud(); // ä¿®æ”¹å¾Œç«‹å³åŒæ­¥
            renderSettings(); 
        } 
    }

    function renderSettings() { 
        const r = (id, list, type) => { const el = document.getElementById(id); el.innerHTML = ''; list.forEach((c, i) => el.innerHTML += `<div class="d-flex justify-content-between p-1 border-bottom"><span>${c}</span><button class="btn btn-sm btn-outline-danger" onclick="removeCat('${type}', ${i})">Ã—</button></div>`); }; 
        r('expenseCatList', settings.expense, 'expense'); r('incomeCatList', settings.income, 'income'); 
        const m = document.getElementById('mealOptionList'); m.innerHTML=''; 
        settings.mealOptions.forEach((o,i) => {
            m.innerHTML += `<div class="badge bg-warning text-dark p-2 border me-1 mb-1">${o} <i class="fas fa-edit ms-1" style="cursor:pointer" onclick="editMealOpt(${i})"></i><i class="fas fa-times ms-1" style="cursor:pointer" onclick="removeMealOpt(${i})"></i></div>`;
        });
    }

    // 6. ä½¿ç”¨è€…ç®¡ç†
    document.getElementById('newUserForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const newU = document.getElementById('newUsername').value.trim();
        if(cloudUsers.some(x => String(x.username) === newU)) { alert('å¸³è™Ÿå·²å­˜åœ¨'); return; }
        const payload = { op: 'add', tableName: 'users', username: newU, name: document.getElementById('newRealname').value.trim(), password: document.getElementById('newPassword').value, role: document.getElementById('newRole').value };
        sendCloudCommand(payload, 'ä½¿ç”¨è€…æ–°å¢æˆåŠŸ', () => document.getElementById('newUserForm').reset());
        logToCloud('æ–°å¢äººå“¡', `å¸³è™Ÿ: ${newU}`);
    });
    function deleteUser(username) {
        if(username === 'admin') { alert('ç„¡æ³•åˆªé™¤é è¨­ç®¡ç†å“¡'); return; }
        if(confirm(`ç¢ºå®šåˆªé™¤ä½¿ç”¨è€… ${username} å—ï¼Ÿ`)) { sendCloudCommand({ op: 'delete', tableName: 'users', id: username }, 'åˆªé™¤æˆåŠŸ'); logToCloud('åˆªé™¤äººå“¡', `å¸³è™Ÿ: ${username}`); }
    }
    function renderUserList() {
        const tbody = document.getElementById('userListBody'); tbody.innerHTML = '';
        cloudUsers.forEach(u => {
            const delBtn = u.username === 'admin' || u.username === currentUser.username ? '-' : `<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.username}')">åˆªé™¤</button>`;
            tbody.innerHTML += `<tr><td>${u.username}</td><td>${u.name}</td><td>${u.role}</td><td>${delBtn}</td></tr>`;
        });
    }
    function renderLogs() {
        const tbody = document.getElementById('logListBody'); tbody.innerHTML = '';
        cloudLogs.slice().reverse().slice(0, 100).forEach(log => { tbody.innerHTML += `<tr><td>${log.time}</td><td>${log.user}</td><td>${log.action}</td><td>${log.detail}</td></tr>`; });
    }

    // 7. æ¸²æŸ“ & å ±è¡¨
    function renderTable() {
        const tbody = document.getElementById('transactionList'); tbody.innerHTML = ''; let balance = 0;
        transactions.sort((a,b) => new Date(b.date) - new Date(a.date));
        transactions.forEach(t => {
            if(t.type === 'income') balance += parseInt(t.amount); else balance -= parseInt(t.amount);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${t.date}</td><td><span class="badge bg-light text-dark border">${t.category}</span></td><td>${t.desc}</td><td class="text-end text-${t.type==='income'?'success':'danger'}">${parseInt(t.amount).toLocaleString()}</td>
                <td><button class="btn btn-sm btn-outline-primary" onclick="editTrans('${t.id}')"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-outline-danger" onclick="deleteTrans('${t.id}')"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('currentBalance').innerText = 'ç¸½é¤˜é¡: ' + balance.toLocaleString();
    }
    
    function editTrans(id){ const t=transactions.find(x=>String(x.id)===String(id)); if(!t)return; document.getElementById('editId').value=t.id; document.getElementById('date').value=t.date; document.getElementById('type').value=t.type; document.getElementById('amount').value=t.amount; updateCategoriesFromSettings(); document.getElementById('category').value=t.category; checkMealCategory(); 
        if(t.category==='é¤è²»æ”¯å‡º'){
            const sel=document.getElementById('descSelect'); 
            if(settings.mealOptions.includes(t.desc)) sel.value=t.desc; 
            else{ sel.value='other'; document.getElementById('descOtherInput').value=t.desc; checkMealOption(); }
        }else{document.getElementById('descInput').value=t.desc;} 
        document.getElementById('formTitle').innerText='ä¿®æ”¹æ¨¡å¼'; document.getElementById('formTitle').className='card-header bg-warning text-dark'; document.getElementById('submitBtn').innerHTML='ğŸ’¾ å„²å­˜ä¿®æ”¹'; document.getElementById('submitBtn').className='btn btn-warning w-100'; document.getElementById('cancelEditBtn').classList.remove('d-none'); window.scrollTo({top:0,behavior:'smooth'}); 
    }
    function cancelEdit(){ document.getElementById('accountForm').reset(); document.getElementById('editId').value=''; document.getElementById('date').value=getTodayString(); document.getElementById('formTitle').innerText='æ–°å¢äº¤æ˜“'; document.getElementById('formTitle').className='card-header bg-primary text-white'; document.getElementById('submitBtn').innerHTML='<i class="fas fa-check"></i> è¨˜éŒ„ä¸¦é€å‡º'; document.getElementById('submitBtn').className='btn btn-primary w-100'; document.getElementById('cancelEditBtn').classList.add('d-none'); checkMealCategory(); }
    function updateCategoriesFromSettings() { const type = document.getElementById('type').value; const catSelect = document.getElementById('category'); catSelect.innerHTML = ''; settings[type].forEach(cat => catSelect.add(new Option(cat, cat))); }
    function checkMealCategory() { const isMeal = document.getElementById('category').value === 'é¤è²»æ”¯å‡º'; document.getElementById('descInput').classList.toggle('d-none', isMeal); document.getElementById('descSelect').classList.toggle('d-none', !isMeal); document.getElementById('descOtherInput').classList.add('d-none'); if (isMeal) { const sel = document.getElementById('descSelect'); sel.innerHTML = ''; settings.mealOptions.forEach(o => sel.add(new Option(o, o))); sel.add(new Option('å…¶ä»– (æ‰‹å‹•è¼¸å…¥)', 'other')); checkMealOption(); } }
    function checkMealOption() { document.getElementById('descOtherInput').classList.toggle('d-none', document.getElementById('descSelect').value !== 'other'); }
    
    function updateDateRange() { const m=document.getElementById('reportPeriodMode').value, s=document.getElementById('reportStartDate'), e=document.getElementById('reportEndDate'), n=new Date(); if(m==='thisMonth'){s.value=new Date(n.getFullYear(),n.getMonth(),1).toISOString().slice(0,10);e.value=new Date(n.getFullYear(),n.getMonth()+1,0).toISOString().slice(0,10);} else if(m==='lastMonth'){s.value=new Date(n.getFullYear(),n.getMonth()-1,1).toISOString().slice(0,10);e.value=new Date(n.getFullYear(),n.getMonth(),0).toISOString().slice(0,10);} updatePreviewStats(); }
    function getReportData(s,e){ let arr=[...transactions].sort((a,b)=>new Date(a.date)-new Date(b.date)); let open=0, incS={}, expS={}, tI=0, tE=0; settings.income.forEach(c=>incS[c]=0); settings.expense.forEach(c=>expS[c]=0); arr.forEach(t=>{ if(t.date<s){ if(t.type==='income')open+=parseInt(t.amount); else open-=parseInt(t.amount); } else if(t.date>=s && t.date<=e){ if(t.type==='income'){ if(!incS[t.category])incS[t.category]=0; incS[t.category]+=parseInt(t.amount); tI+=parseInt(t.amount); } else{ if(!expS[t.category])expS[t.category]=0; expS[t.category]+=parseInt(t.amount); tE+=parseInt(t.amount); } } }); return {openingBalance:open, periodData:arr.filter(t=>t.date>=s&&t.date<=e), incStats:incS, expStats:expS, totalInc:tI, totalExp:tE}; }
    function updatePreviewStats() { const s=document.getElementById('reportStartDate').value, e=document.getElementById('reportEndDate').value; if(!s||!e)return; const d = getReportData(s,e); const ib=document.getElementById('preview-income-body'), eb=document.getElementById('preview-expense-body'); ib.innerHTML=`<tr><td>ä¸ŠæœŸé¤˜é¡</td><td class="text-end">${d.openingBalance.toLocaleString()}</td></tr>`; eb.innerHTML=''; for(const[c,v]of Object.entries(d.incStats))if(v>0)ib.innerHTML+=`<tr><td>${c}</td><td class="text-end">${v.toLocaleString()}</td></tr>`; for(const[c,v]of Object.entries(d.expStats))if(v>0)eb.innerHTML+=`<tr><td>${c}</td><td class="text-end">${v.toLocaleString()}</td></tr>`; const g=d.totalInc+d.openingBalance; document.getElementById('preview-final-balance').textContent=(g-d.totalExp).toLocaleString(); }
    
    function exportLastMonthData() {
        const today = new Date();
        const endStr = today.toISOString().slice(0,10);
        const lastMonth = new Date(); lastMonth.setMonth(lastMonth.getMonth() - 1);
        const startStr = lastMonth.toISOString().slice(0,10);
        exportComplexExcel(startStr, endStr);
    }

    function exportComplexExcel(startOverride, endOverride) {
        const s = startOverride || document.getElementById('reportStartDate').value;
        const e = endOverride || document.getElementById('reportEndDate').value;
        if(!s || !e) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
        const d = getReportData(s, e);
        const wb = XLSX.utils.book_new();
        let detailData = [['æ—¥æœŸ', 'æ”¶æ”¯é¡å‹', 'åˆ†é¡', 'å…§å®¹ (å‚™è¨»)', 'æ”¶å…¥', 'æ”¯å‡º', 'ç¶“æ‰‹äºº']];
        d.periodData.forEach(t => { detailData.push([ t.date, t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º', t.category, t.desc, t.type === 'income' ? parseInt(t.amount) : 0, t.type === 'expense' ? parseInt(t.amount) : 0, t.createdBy || '' ]); });
        const ws1 = XLSX.utils.aoa_to_sheet(detailData); ws1['!cols'] = [{wch:12}, {wch:10}, {wch:15}, {wch:30}, {wch:10}, {wch:10}, {wch:10}];
        XLSX.utils.book_append_sheet(wb, ws1, "æœŸé–“å¸³å‹™æ˜ç´°");
        let summaryData = [['çµ±è¨ˆé …ç›®', 'é‡‘é¡', 'èªªæ˜'], ['çµ±è¨ˆæœŸé–“', `${s} ~ ${e}`, ''], ['æœŸåˆé¤˜é¡', d.openingBalance, 'çµè½‰ä¸ŠæœŸç´¯ç©é¤˜é¡'], ['', '', ''], ['ã€æ”¶å…¥çµ±è¨ˆã€‘', '', '']];
        for(let [cat, amt] of Object.entries(d.incStats)) { if(amt > 0) summaryData.push([cat, amt, 'æ”¶å…¥åˆ†é¡å°è¨ˆ']); } summaryData.push(['æ”¶å…¥ç¸½è¨ˆ', d.totalInc, 'æœ¬æœŸç¸½æ”¶å…¥'], ['', '', ''], ['ã€æ”¯å‡ºçµ±è¨ˆã€‘', '', '']);
        for(let [cat, amt] of Object.entries(d.expStats)) { if(amt > 0) summaryData.push([cat, amt, 'æ”¯å‡ºåˆ†é¡å°è¨ˆ']); } summaryData.push(['æ”¯å‡ºç¸½è¨ˆ', d.totalExp, 'æœ¬æœŸç¸½æ”¯å‡º'], ['', '', ''], ['æœ¬æœŸçµé¤˜', d.openingBalance + d.totalInc - d.totalExp, 'æœŸåˆ + ç¸½æ”¶å…¥ - ç¸½æ”¯å‡º']);
        const ws2 = XLSX.utils.aoa_to_sheet(summaryData); ws2['!cols'] = [{wch:20}, {wch:15}, {wch:25}];
        XLSX.utils.book_append_sheet(wb, ws2, "æ”¶æ”¯åŒ¯æ•´ç¸½è¡¨");
        XLSX.writeFile(wb, `é«˜ç™»ç§‘éœä¿®æ ¡_å ±è¡¨_${s}_${e}.xlsx`);
    }
</script>
</body>
</html>
