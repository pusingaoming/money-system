<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ç™»ç§‘ã€éœä¿®æ ¡ã€‘é›²ç«¯å¸³å‹™ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* èƒŒæ™¯è‰²: æ·¡ç²‰ç´… */
        body { background-color: #ffecec; font-family: "Microsoft JhengHei", sans-serif; }
        .main-title { color: #0099cc; font-weight: bold; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
        .highlight-red { color: #dc3545; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; border-radius: 10px; margin-bottom: 20px; }
        .card-header { background-color: #0d6efd; color: white; font-weight: bold; }
        #amount { background-color: #ffdddd; border-color: #ffcccc; font-weight: bold; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: #f1f1f1; }
        .sort-icon { font-size: 0.8em; margin-left: 5px; color: #aaa; }
        .sort-active { color: #0d6efd; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,236,236, 0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .d-none { display: none !important; }
        
        /* è®€å–ä¸­çš„é®ç½© */
        #loading-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.5); z-index: 10000; 
            display: none; justify-content: center; align-items: center; color: white; flex-direction: column;
        }
        .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border text-light mb-3" role="status"></div>
    <h4 id="loading-text">è³‡æ–™åŒæ­¥ä¸­...</h4>
</div>

<div id="login-overlay">
    <div class="card p-4" style="width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        <div class="text-center mb-3">
            <h3 class="main-title">ç³»çµ±ç™»å…¥</h3>
            <small class="text-muted">é«˜ç™»ç§‘<span class="highlight-red">ã€éœä¿®æ ¡ã€‘</span>é›²ç«¯å¸³å‹™</small>
        </div>
        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label">å¸³è™Ÿ</label>
                <input type="text" class="form-control" id="loginUser" required value="admin">
            </div>
            <div class="mb-3">
                <label class="form-label">å¯†ç¢¼</label>
                <input type="password" class="form-control" id="loginPass" required placeholder="é è¨­: 54381017">
            </div>
            <button type="submit" class="btn btn-primary w-100">ç™»å…¥ä¸¦é€£ç·šè³‡æ–™åº«</button>
            <div id="loginError" class="text-danger text-center mt-2 small"></div>
        </form>
    </div>
</div>

<div class="container py-4" id="main-app" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="main-title m-0"><i class="fas fa-cloud"></i> é«˜ç™»ç§‘<span class="highlight-red">ã€éœä¿®æ ¡ã€‘</span>é›²ç«¯å¸³å‹™</h2>
        <div>
            <span class="me-2 text-secondary"><i class="fas fa-user-circle"></i> <span id="displayUsername">User</span></span>
            <button class="btn btn-sm btn-outline-danger" onclick="location.reload()">ç™»å‡º</button>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#input"><i class="fas fa-pen"></i> æ”¶æ”¯ç™»éŒ„</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#report" onclick="updateDateRange()"><i class="fas fa-chart-pie"></i> å ±è¡¨åŒ¯æ•´</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#manage"><i class="fas fa-cogs"></i> è¨­å®š</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="input">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header" id="formTitle">æ–°å¢äº¤æ˜“</div>
                        <div class="card-body">
                            <form id="accountForm">
                                <input type="hidden" id="editId">
                                <div class="mb-3"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-control" id="date" required></div>
                                <div class="mb-3"><label class="form-label">æ”¶æ”¯é¡å‹</label><select class="form-select" id="type" onchange="updateCategoriesFromSettings()" required><option value="expense" selected>æ”¯å‡º</option><option value="income">æ”¶å…¥</option></select></div>
                                <div class="mb-3"><label class="form-label">é …ç›®åˆ†é¡</label><select class="form-select" id="category" required onchange="checkMealCategory()"></select></div>
                                <div class="mb-3"><label class="form-label">é‡‘é¡</label><input type="number" class="form-control" id="amount" placeholder="è¼¸å…¥é‡‘é¡" required></div>
                                <div class="mb-3"><label class="form-label">å…§å®¹ (å‚™è¨»)</label><input type="text" class="form-control" id="descInput"><select class="form-select d-none" id="descSelect" onchange="checkMealOption()"></select><input type="text" class="form-control mt-2 d-none" id="descOtherInput" placeholder="åº—å®¶åç¨±"></div>
                                <button type="submit" class="btn btn-primary w-100" id="submitBtn"><i class="fas fa-plus-circle"></i> ä¸Šå‚³è‡³é›²ç«¯</button>
                                <button type="button" class="btn btn-secondary w-100 mt-2 d-none" id="cancelEditBtn" onclick="cancelEdit()">å–æ¶ˆä¿®æ”¹</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-list"></i> é›²ç«¯è³‡æ–™åˆ—è¡¨ <button class="btn btn-sm btn-light ms-2" onclick="fetchCloudData()">ğŸ”„ é‡æ–°æ•´ç†</button></span>
                            <span id="currentBalance" class="badge bg-warning text-dark">0</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-hover table-sm sticky-top">
                                    <thead class="table-light"><tr><th onclick="sortTable('date')">æ—¥æœŸ</th><th>åˆ†é¡</th><th>å…§å®¹</th><th class="text-end">æ”¶å…¥</th><th class="text-end">æ”¯å‡º</th><th>æ“ä½œ</th></tr></thead>
                                    <tbody id="transactionList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="report">
            <div class="card border-info">
                <div class="card-header bg-info text-dark fw-bold">æœŸé–“å ±è¡¨çµ±è¨ˆ</div>
                <div class="card-body bg-white">
                    <div class="row g-3 align-items-end mb-4 border-bottom pb-3">
                        <div class="col-md-3"><label class="form-label">æœŸé–“æ¨¡å¼</label><select class="form-select" id="reportPeriodMode" onchange="updateDateRange()"><option value="thisMonth" selected>æœ¬æœˆ</option><option value="lastMonth">ä¸Šæœˆ</option><option value="custom">è‡ªè¨‚</option></select></div>
                        <div class="col-md-3"><input type="date" class="form-control" id="reportStartDate" onchange="updatePreviewStats()"></div>
                        <div class="col-md-3"><input type="date" class="form-control" id="reportEndDate" onchange="updatePreviewStats()"></div>
                        <div class="col-md-3"><button class="btn btn-danger w-100" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> åŒ¯å‡º PDF</button></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><div class="card h-100 border-success"><div class="card-header bg-success text-white">æ”¶å…¥</div><div class="card-body p-0"><table class="table table-striped mb-0"><tbody id="preview-income-body"></tbody></table></div></div></div>
                        <div class="col-md-6"><div class="card h-100 border-danger"><div class="card-header bg-danger text-white">æ”¯å‡º</div><div class="card-body p-0"><table class="table table-striped mb-0"><tbody id="preview-expense-body"></tbody></table></div></div></div>
                    </div>
                    <div class="alert alert-secondary text-center fw-bold">æœ¬æœŸçµé¤˜: <span id="preview-final-balance" class="text-primary fs-5">0</span></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="manage">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">æ”¶æ”¯é …ç›®åˆ†é¡ (æœ¬æ©Ÿè¨­å®š)</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 border-end"><h6>æ”¯å‡ºåˆ†é¡</h6><div class="input-group mb-2"><input type="text" class="form-control" id="newExpenseCat"><button class="btn btn-outline-danger" onclick="addCategory('expense')">æ–°å¢</button></div><div id="expenseCatList"></div></div>
                        <div class="col-md-6"><h6>æ”¶å…¥åˆ†é¡</h6><div class="input-group mb-2"><input type="text" class="form-control" id="newIncomeCat"><button class="btn btn-outline-success" onclick="addCategory('income')">æ–°å¢</button></div><div id="incomeCatList"></div></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-success text-white">Excel åŒ¯å‡º</div>
                <div class="card-body"><button class="btn btn-success" onclick="exportExcel()"><i class="fas fa-file-excel"></i> ä¸‹è¼‰ Excel ç¸½è¡¨</button></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // â–¼â–¼â–¼ æ‚¨çš„å°ˆå±¬é›²ç«¯ç¶²å€ â–¼â–¼â–¼
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzGnWo-GWlavpYjMb5I6IwCIAsMlSeu2eHou2chlJPJELckyTU7bsln1Ho7F68n2VA-Gw/exec';
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    // è³‡æ–™è®Šæ•¸ (æ”¹ç‚ºå¾é›²ç«¯æŠ“å–)
    let transactions = [];
    let currentUser = null;
    let settings = JSON.parse(localStorage.getItem('accSettings')) || {
        expense: ["è£œç¿’ç­é›œæ”¯", "æ•™ææ–‡å…·é¡æ”¯å‡º", "å¹´åº¦æ•™æ(å¸³è™Ÿ/åˆç´„)", "é¤è²»æ”¯å‡º", "åŠ æ²¹", "æ°´é›»è²» é›»è©±è²»", "å…¶ä»–äººäº‹æ”¯å‡º", "è»Šè¼›ç›¸é—œæ”¯å‡º"],
        income: ["å…¥å¸³(é›¶ç”¨é‡‘)", "å­¸ç”Ÿè½‰å…¥é¤è²»", "å…¶ä»–æ”¶å…¥"],
        mealOptions: ["å¤©é£Ÿé‹ç‡’", "Bé´¨è‘£", "ä¾†ç¢—ç²¥", "é£¯å·", "æ°´é¤ƒå³°", "å¤ªç¥–é­·é­šç¾®", "å…«æ–¹é‹èƒ‹", "é˜¿èƒ–é£Ÿå ‚", "é»å¿ƒ"]
    };

    // 1. åˆå§‹åŒ–èˆ‡ç™»å…¥
    function getTodayString() { const n=new Date(); return new Date(n.getTime()-(n.getTimezoneOffset()*60000)).toISOString().slice(0,10); }

    document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        
        // é è¨­å¯†ç¢¼é©—è­‰
        if(p === '54381017' || p === 'admin') {
            currentUser = { name: 'ç®¡ç†å“¡', username: u };
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('displayUsername').innerText = currentUser.name;
            document.getElementById('date').value = getTodayString();
            renderSettings();
            updateCategoriesFromSettings();
            fetchCloudData(); // ğŸ”¥ ç™»å…¥æˆåŠŸå¾Œï¼Œç«‹åˆ»å¾é›²ç«¯æŠ“è³‡æ–™
        } else {
            document.getElementById('loginError').innerText = 'å¯†ç¢¼éŒ¯èª¤ (é è¨­ 54381017)';
        }
    });

    // 2. é›²ç«¯æ ¸å¿ƒåŠŸèƒ½ (Fetch)
    function showLoading(text) { document.getElementById('loading-text').innerText = text; document.getElementById('loading-overlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

    // è®€å–è³‡æ–™ (Read)
    function fetchCloudData() {
        showLoading('æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰å¸³å‹™è³‡æ–™...');
        fetch(scriptURL)
        .then(res => res.json())
        .then(res => {
            if(res.result === 'success') {
                transactions = res.data; // æ›´æ–°æœ¬åœ°è³‡æ–™
                renderTable();
                updatePreviewStats();
            } else {
                console.error('API Error:', res);
                // å®¹éŒ¯ï¼šå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè³‡æ–™å¯èƒ½æ˜¯ç©ºçš„ï¼Œé€™ä¸ç®—æ˜¯åš´é‡éŒ¯èª¤
                if(res.message && res.message.includes('ID not found')) return;
                alert('è®€å–å¤±æ•—: ' + (res.message || 'æœªçŸ¥éŒ¯èª¤'));
            }
        })
        .catch(err => {
            console.error(err);
            alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¢ºèª Apps Script éƒ¨ç½²æ˜¯å¦æ­£ç¢ºã€‚');
        })
        .finally(() => hideLoading());
    }

    // å‚³é€è³‡æ–™ (Add / Edit / Delete)
    function sendCloudCommand(payload, successMsg) {
        showLoading('è³‡æ–™åŒæ­¥ä¸­...');
        fetch(scriptURL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(res => res.json())
        .then(res => {
            if(res.result === 'success') {
                fetchCloudData(); // æˆåŠŸå¾Œé‡æ–°æŠ“å–
                if(successMsg) alert(successMsg);
                if(payload.op === 'add' || payload.op === 'edit') cancelEdit();
            } else {
                alert('æ“ä½œå¤±æ•—: ' + res.message);
            }
        })
        .catch(err => alert('é€£ç·šéŒ¯èª¤'))
        .finally(() => hideLoading());
    }

    // 3. è¡¨å–®æäº¤ (æ–°å¢/ä¿®æ”¹)
    document.getElementById('accountForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const cat = document.getElementById('category').value;
        let finalDesc = cat === 'é¤è²»æ”¯å‡º' && document.getElementById('descSelect').value === 'other' ? document.getElementById('descOtherInput').value.trim() : (cat === 'é¤è²»æ”¯å‡º' ? document.getElementById('descSelect').value : document.getElementById('descInput').value.trim());
        
        const editId = document.getElementById('editId').value;
        const payload = {
            op: editId ? 'edit' : 'add',
            id: editId ? editId : Date.now(),
            date: document.getElementById('date').value,
            type: document.getElementById('type').value,
            category: cat,
            amount: document.getElementById('amount').value,
            desc: finalDesc,
            createdBy: currentUser.username
        };

        sendCloudCommand(payload, editId ? 'ä¿®æ”¹æˆåŠŸ' : 'æ–°å¢æˆåŠŸ');
    });

    // 4. åˆªé™¤èˆ‡ç·¨è¼¯æº–å‚™
    function deleteTrans(id) {
        if(confirm('ç¢ºå®šè¦å¾é›²ç«¯åˆªé™¤æ­¤ç­†è³‡æ–™å—ï¼Ÿ(ç„¡æ³•å¾©åŸ)')) {
            sendCloudCommand({ op: 'delete', id: id }, 'åˆªé™¤æˆåŠŸ');
        }
    }

    function editTrans(id) {
        const t = transactions.find(x => String(x.id) === String(id));
        if(!t) return;
        document.getElementById('editId').value = t.id;
        document.getElementById('date').value = t.date;
        document.getElementById('type').value = t.type;
        document.getElementById('amount').value = t.amount;
        updateCategoriesFromSettings();
        document.getElementById('category').value = t.category;
        checkMealCategory();
        
        if (t.category === 'é¤è²»æ”¯å‡º') {
            const sel = document.getElementById('descSelect');
            if (settings.mealOptions.includes(t.desc)) sel.value = t.desc;
            else { sel.value = 'other'; document.getElementById('descOtherInput').value = t.desc; checkMealOption(); }
        } else {
            document.getElementById('descInput').value = t.desc;
        }

        document.getElementById('formTitle').innerText = 'ä¿®æ”¹æ¨¡å¼';
        document.getElementById('formTitle').className = 'card-header bg-warning text-dark';
        document.getElementById('submitBtn').innerHTML = 'ğŸ’¾ å„²å­˜ä¿®æ”¹';
        document.getElementById('submitBtn').className = 'btn btn-warning w-100';
        document.getElementById('cancelEditBtn').classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        document.getElementById('accountForm').reset();
        document.getElementById('editId').value = '';
        document.getElementById('date').value = getTodayString();
        document.getElementById('formTitle').innerText = 'æ–°å¢äº¤æ˜“';
        document.getElementById('formTitle').className = 'card-header bg-primary text-white';
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-plus-circle"></i> ä¸Šå‚³è‡³é›²ç«¯';
        document.getElementById('submitBtn').className = 'btn btn-primary w-100';
        document.getElementById('cancelEditBtn').classList.add('d-none');
        checkMealCategory();
    }

    // 5. ç•«é¢æ¸²æŸ“èˆ‡å·¥å…·
    function renderTable() {
        const tbody = document.getElementById('transactionList');
        tbody.innerHTML = '';
        let balance = 0;
        // æ’åº
        transactions.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        transactions.forEach(t => {
            if(t.type === 'income') balance += parseInt(t.amount); else balance -= parseInt(t.amount);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${t.date}</td>
                <td><span class="badge bg-light text-dark border">${t.category}</span></td>
                <td>${t.desc}</td>
                <td class="text-end text-success">${t.type==='income'? parseInt(t.amount).toLocaleString():''}</td>
                <td class="text-end text-danger">${t.type==='expense'? parseInt(t.amount).toLocaleString():''}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editTrans('${t.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTrans('${t.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('currentBalance').innerText = 'ç¸½é¤˜é¡: ' + balance.toLocaleString();
    }

    // è¨­å®šèˆ‡å…¶ä»–è¼”åŠ©å‡½å¼
    function updateCategoriesFromSettings() { const type = document.getElementById('type').value; const catSelect = document.getElementById('category'); catSelect.innerHTML = ''; settings[type].forEach(cat => catSelect.add(new Option(cat, cat))); }
    function renderSettings() { 
        const r = (id, list, type) => { const el = document.getElementById(id); el.innerHTML = ''; list.forEach((c, i) => el.innerHTML += `<div class="d-flex justify-content-between p-1 border-bottom"><span>${c}</span><button class="btn btn-sm btn-outline-danger" onclick="removeCat('${type}', ${i})">Ã—</button></div>`); }; 
        r('expenseCatList', settings.expense, 'expense'); r('incomeCatList', settings.income, 'income'); 
    }
    function addCategory(t){ const v=document.getElementById(t==='expense'?'newExpenseCat':'newIncomeCat').value.trim(); if(v){settings[t].push(v);localStorage.setItem('accSettings',JSON.stringify(settings));renderSettings();updateCategoriesFromSettings();}}
    function removeCat(t,i){if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){settings[t].splice(i,1);localStorage.setItem('accSettings',JSON.stringify(settings));renderSettings();updateCategoriesFromSettings();}}
    function checkMealCategory() { const isMeal = document.getElementById('category').value === 'é¤è²»æ”¯å‡º'; document.getElementById('descInput').classList.toggle('d-none', isMeal); document.getElementById('descSelect').classList.toggle('d-none', !isMeal); document.getElementById('descOtherInput').classList.add('d-none'); if (isMeal) { const sel = document.getElementById('descSelect'); sel.innerHTML = ''; settings.mealOptions.forEach(o => sel.add(new Option(o, o))); sel.add(new Option('å…¶ä»–', 'other')); checkMealOption(); } }
    function checkMealOption() { document.getElementById('descOtherInput').classList.toggle('d-none', document.getElementById('descSelect').value !== 'other'); }
    
    // å ±è¡¨ PDF/Excel åŠŸèƒ½
    function updateDateRange() { const m=document.getElementById('reportPeriodMode').value, s=document.getElementById('reportStartDate'), e=document.getElementById('reportEndDate'), n=new Date(); if(m==='thisMonth'){s.value=new Date(n.getFullYear(),n.getMonth(),1).toISOString().slice(0,10);e.value=new Date(n.getFullYear(),n.getMonth()+1,0).toISOString().slice(0,10);} else if(m==='lastMonth'){s.value=new Date(n.getFullYear(),n.getMonth()-1,1).toISOString().slice(0,10);e.value=new Date(n.getFullYear(),n.getMonth(),0).toISOString().slice(0,10);} updatePreviewStats(); }
    function getReportData(s,e){ let arr=[...transactions].sort((a,b)=>new Date(a.date)-new Date(b.date)); let open=0, incS={}, expS={}, tI=0, tE=0; settings.income.forEach(c=>incS[c]=0); settings.expense.forEach(c=>expS[c]=0); arr.forEach(t=>{ if(t.date<s){ if(t.type==='income')open+=parseInt(t.amount); else open-=parseInt(t.amount); } else if(t.date>=s && t.date<=e){ if(t.type==='income'){ if(!incS[t.category])incS[t.category]=0; incS[t.category]+=parseInt(t.amount); tI+=parseInt(t.amount); } else{ if(!expS[t.category])expS[t.category]=0; expS[t.category]+=parseInt(t.amount); tE+=parseInt(t.amount); } } }); return {openingBalance:open, periodData:arr.filter(t=>t.date>=s&&t.date<=e), incStats:incS, expStats:expS, totalInc:tI, totalExp:tE}; }
    function updatePreviewStats() { const s=document.getElementById('reportStartDate').value, e=document.getElementById('reportEndDate').value; if(!s||!e)return; const d = getReportData(s,e); const ib=document.getElementById('preview-income-body'), eb=document.getElementById('preview-expense-body'); ib.innerHTML=`<tr><td>ä¸ŠæœŸé¤˜é¡</td><td class="text-end">${d.openingBalance.toLocaleString()}</td></tr>`; eb.innerHTML=''; for(const[c,v]of Object.entries(d.incStats))if(v>0)ib.innerHTML+=`<tr><td>${c}</td><td class="text-end">${v.toLocaleString()}</td></tr>`; for(const[c,v]of Object.entries(d.expStats))if(v>0)eb.innerHTML+=`<tr><td>${c}</td><td class="text-end">${v.toLocaleString()}</td></tr>`; const g=d.totalInc+d.openingBalance; document.getElementById('preview-final-balance').textContent=(g-d.totalExp).toLocaleString(); }
    function generatePDF(){
        const s = document.getElementById('reportStartDate').value; const e = document.getElementById('reportEndDate').value; 
        if(!s||!e){alert('è«‹é¸æ“‡æ—¥æœŸ');return;} const d = getReportData(s,e);
        const printContainer = document.createElement('div'); printContainer.style.cssText = "position:absolute; top:0; left:0; width:100%; min-height:100vh; background:white; z-index:999999; padding:20px; color:black;";
        let html = `<h2 style='text-align:center;'>é«˜ç™»ç§‘ã€éœä¿®æ ¡ã€‘æ”¶æ”¯è¡¨</h2><p style='text-align:center;'>${s} ~ ${e}</p><table style='width:100%; border-collapse:collapse; border:1px solid black;'><thead><tr style='background:#eee;'><th style='border:1px solid black;'>æ—¥æœŸ</th><th style='border:1px solid black;'>åˆ†é¡</th><th style='border:1px solid black;'>æ”¶</th><th style='border:1px solid black;'>æ”¯</th><th style='border:1px solid black;'>é¤˜</th><th style='border:1px solid black;'>å‚™è¨»</th></tr></thead><tbody>`;
        let bal = d.openingBalance; html += `<tr><td>${s}</td><td colspan='3' style='text-align:center;'>ã€ä¸ŠæœŸé¤˜é¡ã€‘</td><td>${bal}</td><td></td></tr>`;
        d.periodData.forEach(t => { if(t.type === 'income') bal += parseInt(t.amount); else bal -= parseInt(t.amount); html += `<tr><td style='border:1px solid black;'>${t.date}</td><td style='border:1px solid black;'>${t.category}</td><td style='border:1px solid black;'>${t.type==='income'?t.amount:''}</td><td style='border:1px solid black;'>${t.type==='expense'?t.amount:''}</td><td style='border:1px solid black;'>${bal}</td><td style='border:1px solid black;'>${t.desc}</td></tr>`; });
        html += `</tbody></table>`;
        printContainer.innerHTML = html; document.body.appendChild(printContainer);
        html2pdf().from(printContainer).save(`${s}_å ±è¡¨.pdf`).then(() => document.body.removeChild(printContainer));
    }
    function exportExcel() {
        const s = document.getElementById('reportStartDate').value || '2000-01-01', e = document.getElementById('reportEndDate').value || '2099-12-31';
        const d = getReportData(s,e);
        const ws = XLSX.utils.json_to_sheet(d.periodData.map(t=>({æ—¥æœŸ:t.date, é¡å‹:t.type, åˆ†é¡:t.category, é‡‘é¡:t.amount, å‚™è¨»:t.desc})));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "å¸³å‹™è³‡æ–™");
        XLSX.writeFile(wb, "é›²ç«¯å¸³å‹™åŒ¯å‡º.xlsx");
    }
</script>
</body>
</html>
